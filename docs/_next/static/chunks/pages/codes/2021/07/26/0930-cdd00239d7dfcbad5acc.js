_N_E=(window.webpackJsonp_N_E=window.webpackJsonp_N_E||[]).push([[76],{OE75:function(t,n,e){(window.__NEXT_P=window.__NEXT_P||[]).push(["/codes/2021/07/26/0930",function(){return e("QiSH")}])},QiSH:function(t,n,e){"use strict";e.r(n),e.d(n,"default",(function(){return u}));var r=e("rePB"),o=e("Ff2n"),s=(e("q1tI"),e("7ljp")),a=e("3wrV");function i(t,n){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(t,n).enumerable}))),e.push.apply(e,r)}return e}function c(t){for(var n=1;n<arguments.length;n++){var e=null!=arguments[n]?arguments[n]:{};n%2?i(Object(e),!0).forEach((function(n){Object(r.a)(t,n,e[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):i(Object(e)).forEach((function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))}))}return t}var p={};function u(t){var n=t.components,e=Object(o.a)(t,["components"]);return Object(s.a)("wrapper",c(c(c({},p),e),{},{components:n,mdxType:"MDXLayout"}),Object(s.a)("h1",null,"\u6570\u636e\u67e5\u8be2\u670d\u52a1"),Object(s.a)(a.a,{lan:"ts",code:"\nimport { PageConfig } from 'next';\nimport an48 from '@mmstudio/an000048';\nimport anylogger from 'anylogger';\nimport '@mmstudio/an000042';\nimport an49 from '@mmstudio/an000049';\nimport getuser from '../../../../atoms/getuser';\n\nconst logger = anylogger('pages/api/xxx/query');\n\nexport type Result = {\n\tcount: number;\n\tdata: IData[];\n};\n\nexport type Query = {\n\tq: string;\n\tpage: string;\n\tpagesize: string;\n}\n\nexport type IData = Pick<ITbxxx, 'id'|'xxx'>;\n\n/**\n * \u641c\u7d22/\u67e5\u8be2\n */\nconst handler = an48<Result>();\n\nhandler.get(async (req, res) => {\n\ttry {\n\t\tlogger.debug('msg body:', req.body);\n\t\tconst { q, ...rest } = req.query as Query;\n\t\tconst page = Number(rest.page || '1');\n\t\tconst pagesize = Number(rest.pagesize || '10');\n\t\tconst user = await getuser(req);\n\t\tif (user.role !== 'admin') {\n\t\t\treturn { data: [], count: 0 };\n\t\t}\n\t\tconst db = an49();\n\t\tconst dt1 = db<ITbxxx>('xxx');\n\t\tif (q && typeof q === 'string') {\n\t\t\tdt1.where('xxx', 'like', `%${q}%`);\n\t\t}\n\t\tconst [{ size }] = await dt1.count('*', { as: 'size' });\n\t\tconst count = Number(size);\n\t\tconst dt2 = db<ITbxxx>('xxx');\n\t\tif (q && typeof q === 'string') {\n\t\t\tdt2.where('xxx', 'like', `%${q}%`);\n\t\t}\n\t\tconst offset = (page - 1) * pagesize;\n\t\tconst d = await dt2.select('id', 'xxx')\n\t\t\t.limit(pagesize)\n\t\t\t.offset(offset)\n\t\t\t.orderBy('xxx', 'asc');\n\t\tconst data = d.map((it) => {\n\t\t\treturn {\n\t\t\t\t...it\n\t\t\t} as IData;\n\t\t});\n\t\tres.status(200).json({ data, count });\n\t} catch (error) {\n\t\tlogger.error(error);\n\t\tres.status(200).json({\n\t\t\tcount: 0,\n\t\t\tdata: []\n\t\t});\n\t}\n});\n\nexport const config = {} as PageConfig;\n\nexport default handler;\n",mdxType:"CodeEditor"}))}u.isMDXComponent=!0}},[["OE75",0,1,2,4,3,5]]]);