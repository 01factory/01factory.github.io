<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title class="jsx-2893578415">01factory|01微工厂</title><meta name="keywords" content="01factory,dfactory,01" class="jsx-2893578415"/><meta name="description" content="微工厂,从零到壹，数字之道" class="jsx-2893578415"/><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" class="jsx-2893578415"/><link rel="icon" type="image/x-icon" sizes="32x32" href="/favicon-32x32.ico" class="jsx-2893578415"/><link rel="icon" type="image/x-icon" sizes="16x16" href="/favicon-16x16.ico" class="jsx-2893578415"/><meta name="next-head-count" content="8"/><link rel="preload" href="/_next/static/css/350e09057e231801b32f.css" as="style"/><link rel="stylesheet" href="/_next/static/css/350e09057e231801b32f.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.f8bd46fc02868c500bda.js" as="script"/><link rel="preload" href="/_next/static/chunks/6510696646ad4cd66cb0c17a783768443548e3b8.e5ebd9a9dc48937a5931.js" as="script"/><link rel="preload" href="/_next/static/chunks/f6078781a05fe1bcb0902d23dbbb2662c8d200b3.7f522d4c44240e733215.js" as="script"/><link rel="preload" href="/_next/static/chunks/main-bad2ebf842509aaadfd5.js" as="script"/><link rel="preload" href="/_next/static/chunks/693f8c4e356737073a5466c81465a491552d424e.9b340f9d21cfc83997ce.js" as="script"/><link rel="preload" href="/_next/static/chunks/801083a74bf00b93b65919d9815099ccd016c024.47e830ac23167e0dbf80.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-f9a9a13c71df3f6c68ee.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/documents/2021/03/291034-780acedf0f8112b98a37.js" as="script"/></head><body><div id="__next"><div class="jsx-86683480 row "><div class="jsx-180329529 col s002"><div class="jsx-2893578415 outer"><header class="jsx-2893578415 inner"><a class="jsx-2893578415" href="/"><img height="150" width="217" src="/images/logo.png" class="jsx-2893578415 s001"/></a></header></div></div></div><div class="jsx-86683480 row "><div class="jsx-158700623 col "><a class="jsx-2893578415" href="/home_design"><h2 class="jsx-244854117  ">方案文档</h2></a></div><div class="jsx-158700623 col "><a class="jsx-2893578415" href="/"><h2 class="jsx-244854117  ">开发文档</h2></a></div><div class="jsx-158700623 col "><a class="jsx-2893578415" href="/home_ops"><h2 class="jsx-244854117  ">运维文档</h2></a></div></div><div class="jsx-788945023"><h1>定时任务</h1><p>有时候我们需要在业务中定时（定期）执行一些任务。比如说每天晚上服务器空闲时整理当天的报表。或者每月定期结算员工工资等。</p><h2>创建定时任务</h2><p>使用命令<code>mmstudio: Add schedule</code>，<code>mmstudio:添加定时任务</code>或快捷键<code>alt+m s</code>创建定时任务，按步骤操作。</p><h2>修改定时策略</h2><p>打开文件<code>mm.json</code>，修改<code>rule</code>的策略。默认为</p><pre class="language-js"><code class="language-js"><span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span>
</code></pre><p>从左至右第一位表示秒，第二位表示分，第三位表示小时，第四位表示一个月的第几天，取值为<code>1</code>-<code>31</code>之间的整数值。第五位表示第几个月份，取值范围为<code>1</code>-<code>12</code>，第六位表示一周中的第几天，取值范围为<code>0</code>-<code>7</code>，<code>0</code>和<code>7</code>都表示周日，<code>1</code>表示周一，<code>2</code>表示周二，<code>3</code>表示周三，<code>4</code>表示周四，<code>5</code>表示周五，<code>6</code>表示周六。</p><p>还有几种特殊的表示方式需要说明：</p><ul><li><p><code>*</code></p><p>表示不设置，即全部。如默认策略就表示没有设定策略，那么这个定时服务就会<code>一直</code>执行，所谓<code>一直</code>指服务器一有空闲就会执行。实际业务中一般不会用到这种任务。</p></li><li><p><code>m-n</code></p><p>表示从m到n期间都执行，如<code>* * * * * 1-5</code>表示只工作日执行。</p></li><li><p><code>*/n</code></p><p>表示每隔n个时间单位执行一次,如<code>* 30 * * * *</code>表示每隔半小时执行一次。</p></li><li><p><code>m,n</code></p><p>表示m和n都执行，如<code>* * * 10,25 * *</code>表示每月的10号和25号执行。而<code>* * * * * 1,2,3,4,5</code>同样可以表示只有工作日才执行。</p></li><li><p><code>#m</code></p><p>表示第二个，如<code>* * * * * 0#m</code>表示每个月的第二个周日</p></li></ul><p>复杂地，比如我们结算工资的策略为：“每月的10号9点半执行，但如果10号为周末，则延迟到下个周一执行”，我们可以制定两个定时任务来完成。</p><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">&quot;jobs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;s001&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;工资结算&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;rule&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0 30 9 10 * 1-5&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;s001&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;工资结算&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;rule&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0 30 9 11,12 * 1&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><p>两个定时任务同时对应的服务为同一个js文件，第一个规则为</p><pre class="language-js"><code class="language-js"><span class="token number">0</span> <span class="token number">30</span> <span class="token number">9</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1</span><span class="token operator">-</span><span class="token number">5</span>
</code></pre><p>它表示如果每个月10号如果是工作日（1-5）则执行。但会遇到10号为周六和10号为周日的情况，我们使用第二个规则来弥补：</p><pre class="language-js"><code class="language-js"><span class="token number">0</span> <span class="token number">30</span> <span class="token number">9</span> <span class="token number">11</span><span class="token punctuation">,</span><span class="token number">12</span> <span class="token operator">*</span> <span class="token number">1</span>
</code></pre><p>即每个月11号或12号为周一的情况，很明显，如果11号为周一，那么10号就是周日。同样的，如果12号为周一，那么10号那天是周六。</p><p>诸如此类，一些复杂一些的规则可以通过各种组合来完成。</p><p>有些人可能会抬杠：这样不能跳过法定的其它节假日呀！没错，如果要使用<code>真正的</code>节假日，我们是不能（或者说理论上虽然可以，但会因规则会过于复杂实际上不可行）通过简单这样的规则设定来完成的。如果真有这样的需求，我建议设定每天都执行的定时任务<code>0 30 9 * * *</code>，同时维护一个节假日的表（或者公共服务），在代码中根据是否为<code>真正的</code>工作日，然后执行其策略，实现方式会稍简单一些。</p><h2>设置起止时间</h2><p>可以通过设置<code>start</code>和<code>end</code>。</p><h2>开发</h2><p>定时任务的开发需要执行命令<code>yarn dev-schedule</code>。但需注意：</p><ol><li>配置文件<code>mm.json</code>中<code>jobs</code>应有内容。</li><li>配置文件如果有修改，需要再次执行命令<code>yarn dev-schedule</code></li></ol><h2>修改定时任务逻辑</h2><p>打开文件<code>src/schedule/s001</code>，编写代码完成业务逻辑。</p><h2>部署</h2><p>需要先编译<code>yarn build</code>代码，生成js文件（在dist目录）。如果要隐藏原代码，可以在编译完成后将src去掉。</p><p>启动定时任务服务命令为<code>yarn start-schedule</code>。</p><p>建议定时任务与web服务部署时分离。</p></div><div class="jsx-1988653958 outer"><footer class="jsx-1988653958 inner"><a href="https://github.com/01factory/01factory.github.io/edit/main/src/pages/main.md" target="_blank" rel="noreferrer noopener" class="jsx-1988653958"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" class="jsx-1988653958 s001"><g class="jsx-1988653958"><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z" class="jsx-1988653958"></path></g></svg>Edit this page on Github</a><br class="jsx-1988653958"/><a href="https://gitee.com/dfactory01/dfactory01/edit/main/src/pages/main.md" target="_blank" rel="noreferrer noopener" class="jsx-1988653958"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" class="jsx-1988653958 s001"><g class="jsx-1988653958"><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z" class="jsx-1988653958"></path></g></svg>Edit this page on Gitee</a></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/documents/2021/03/291034","query":{},"buildId":"QMQnOD-dptJ4T2xKH5cVA","runtimeConfig":{},"nextExport":true,"autoExport":true,"isFallback":false}</script><script nomodule="" src="/_next/static/chunks/polyfills-8b53b300207b60157587.js"></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.f8bd46fc02868c500bda.js" async=""></script><script src="/_next/static/chunks/6510696646ad4cd66cb0c17a783768443548e3b8.e5ebd9a9dc48937a5931.js" async=""></script><script src="/_next/static/chunks/f6078781a05fe1bcb0902d23dbbb2662c8d200b3.7f522d4c44240e733215.js" async=""></script><script src="/_next/static/chunks/main-bad2ebf842509aaadfd5.js" async=""></script><script src="/_next/static/chunks/693f8c4e356737073a5466c81465a491552d424e.9b340f9d21cfc83997ce.js" async=""></script><script src="/_next/static/chunks/801083a74bf00b93b65919d9815099ccd016c024.47e830ac23167e0dbf80.js" async=""></script><script src="/_next/static/chunks/pages/_app-f9a9a13c71df3f6c68ee.js" async=""></script><script src="/_next/static/chunks/pages/documents/2021/03/291034-780acedf0f8112b98a37.js" async=""></script><script src="/_next/static/QMQnOD-dptJ4T2xKH5cVA/_buildManifest.js" async=""></script><script src="/_next/static/QMQnOD-dptJ4T2xKH5cVA/_ssgManifest.js" async=""></script></body></html>